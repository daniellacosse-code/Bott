#!/usr/bin/env bash
# @license
# This file is part of Bott.
#
# This project is dual-licensed:
# - Non-commercial use: AGPLv3 (see LICENSE file for full text).
# - Commercial use: Proprietary License (contact D@nielLaCos.se for details).
#
# Copyright (C) 2025 DanielLaCos.se

set -euo pipefail

# Get script directory and source utilities
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/utils/log.sh"
source "$SCRIPT_DIR/utils/gcloud.sh"

# Main setup function
main() {
  log_info "Bott Setup Script"
  log_info "================="
  
  # Default environment to devcontainer for setup
  local env="${ENV:-devcontainer}"
  
  # Check if running on macOS
  if [[ "$OSTYPE" == "darwin"* ]]; then
    log_info "Detected macOS"
    
    # Check if brew is installed
    if ! check_homebrew; then
      read -r -p "Homebrew is not installed. Would you like to install it? (y/N): " install_brew
      if [[ "$install_brew" =~ ^[Yy]$ ]]; then
        log_info "Installing Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      else
        log_error "Homebrew is required. Please install it from https://brew.sh"
        exit 1
      fi
    fi
    
    log_info "Installing dependencies via Homebrew..."
    brew bundle
  elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    log_info "Detected Linux"
    
    # Check if apt-get is available (Debian/Ubuntu)
    if command -v apt-get &> /dev/null; then
      log_info "Installing dependencies via apt-get..."
      
      # Install gcloud if not present
      if ! command -v gcloud &> /dev/null; then
        log_info "Installing Google Cloud SDK..."
        sudo apt-get update
        sudo apt-get install -y apt-transport-https ca-certificates gnupg curl
        curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
        echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
        sudo apt-get update
        sudo apt-get install -y google-cloud-cli
      fi
      
      # Install Deno if not present
      if ! command -v deno &> /dev/null; then
        log_info "Installing Deno..."
        curl -fsSL https://deno.land/install.sh | sh
        log_info "Please add Deno to your PATH: export PATH=\"\$HOME/.deno/bin:\$PATH\""
      fi
    else
      log_info "Please manually install the following:"
      log_info "  - Google Cloud SDK (gcloud)"
      log_info "  - Deno runtime"
      log_info ""
      log_info "For more info: https://cloud.google.com/sdk/docs/install"
    fi
  else
    log_info "Detected other system: $OSTYPE"
    log_warn "Please manually install dependencies:"
    log_warn "  - Google Cloud SDK (gcloud)"
    log_warn "  - Deno runtime"
  fi
  
  # Check if gcloud is installed
  check_gcloud
  log_info "gcloud CLI found"
  
  # Authenticate with gcloud
  log_info "Authenticating with Google Cloud..."
  if ! gcloud auth list --filter=status:ACTIVE --format="value(account)" 2>/dev/null | grep -q .; then
    log_info "Running: gcloud auth application-default login"
    gcloud auth application-default login
  else
    log_info "Already authenticated with gcloud"
  fi
  
  # Create environment file
  local env_file=".env.$env"
  if [ ! -f "$env_file" ]; then
    log_info "Creating $env_file from .env.example..."
    cp .env.example "$env_file"
    log_info "Created $env_file"
    
    # Ask if user wants to edit the file
    read -r -p "Would you like to open $env_file in your editor? (y/N): " open_editor
    if [[ "$open_editor" =~ ^[Yy]$ ]]; then
      local editor="${EDITOR:-${VISUAL:-vi}}"
      log_info "Opening $env_file in $editor..."
      "$editor" "$env_file"
    else
      log_info "Please edit $env_file with your configuration"
    fi
  else
    log_info "$env_file already exists"
  fi
  
  log_info ""
  log_info "Setup complete!"
}

# Run main function
main "$@"
